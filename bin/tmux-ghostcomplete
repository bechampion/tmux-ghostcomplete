#!/bin/sh
# tmux-ghostcomplete: Extract tokens from tmux pane for fzf selection
# Optimized: single awk does all processing

target_pane="$2"
exclude_file="$3"

# Capture and process - no tac, fzf --reverse will flip display
if [ -n "$target_pane" ]; then
    tmux capture-pane -t "$target_pane" -p
else
    tmux capture-pane -p
fi | awk -v excludefile="$exclude_file" '
BEGIN {
    # Load words to exclude from file
    if (excludefile != "") {
        while ((getline line < excludefile) > 0) {
            exclude[line] = 1
        }
        close(excludefile)
    }
}
{
    # First pass: extract and mark special patterns to avoid re-processing
    line = $0
    outline = $0
    
    # Match URLs and special schemes (http, https, ftp, file, git@, containerd, s3, etc.)
    while (match(line, /https?:\/\/[^ \t\[\]()]+|git@[^ \t\[\]()]+|ftp:\/\/[^ \t\[\]()]+|file:\/\/[^ \t\[\]()]+|containerd:\/\/[^ \t\[\]()]+|s3:\/\/[^ \t\[\]()]+/)) {
        url = substr(line, RSTART, RLENGTH)
        # Clean trailing punctuation from URLs
        gsub(/[,;:)\]"]+$/, "", url)
        if (length(url) > 4 && !seen[url]++ && !exclude[url]) {
            print url
        }
        # Remove URL from outline to avoid double processing
        sub(url, " ", outline)
        line = substr(line, RSTART + RLENGTH)
    }
    
    # Second pass: extract IPv6 addresses (before stripping colons)
    line = outline
    while (match(line, /[0-9a-fA-F]*:[0-9a-fA-F]*:[0-9a-fA-F:]+/)) {
        ipv6 = substr(line, RSTART, RLENGTH)
        gsub(/[,;)\]"]+$/, "", ipv6)
        if (ipv6 ~ /^[0-9a-fA-F:]+$/ && gsub(/:/, ":", ipv6) >= 2) {
            if (length(ipv6) > 4 && !seen[ipv6]++ && !exclude[ipv6]) {
                print ipv6
            }
        }
        sub(ipv6, " ", outline)
        line = substr(line, RSTART + RLENGTH)
    }
    
    # Third pass: process remaining words (strip brackets, parens, colons, quotes)
    gsub(/[\[\]():"]/, " ", outline)
    n = split(outline, words)
    for (i = 1; i <= n; i++) {
        w = words[i]
        if (length(w) > 4 && !seen[w]++ && !exclude[w]) {
            print w
        }
    }
}'
